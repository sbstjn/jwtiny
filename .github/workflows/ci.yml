name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

env:
  CARGO_TERM_COLOR: always

jobs:
  lint:
    name: Lint and Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt, clippy

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-lint-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-features -- -D warnings

  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-docs-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-docs-
            ${{ runner.os }}-cargo-

      - name: Build documentation
        run: cargo doc --no-deps --all-features

      - name: Test documentation examples
        run: cargo test --doc --all-features

  msrv:
    name: MSRV Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.85.0

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-msrv-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build all targets
        run: cargo build --all-targets

      - name: Run tests (default features)
        run: cargo test --lib --tests --bins --examples

  # Comprehensive tests - run in parallel
  all-tests-tag:
    name: All Tests
    runs-on: ubuntu-latest
    services:
      jwkserve:
        image: sbstjn/jwkserve:latest
        ports:
          - 3000:3000
    strategy:
      fail-fast: false
      matrix:
        include:
          - features: ""
            name: Default (HMAC)
            needs_jwkserve: false
          - features: "rsa"
            name: RSA
            needs_jwkserve: false
          - features: "ecdsa"
            name: ECDSA
            needs_jwkserve: false
          - features: "all-algorithms"
            name: All (Ring)
            needs_jwkserve: false
          - features: "all-algorithms,remote"
            name: All + Remote
            needs_jwkserve: true
          - features: "rsa,aws-lc-rs"
            name: RSA (aws-lc-rs)
            needs_jwkserve: false
          - features: "all-algorithms,aws-lc-rs"
            name: All (aws-lc-rs)
            needs_jwkserve: false
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-all-${{ matrix.name }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-all-${{ matrix.name }}-
            ${{ runner.os }}-cargo-

      - name: Wait for jwkserve to be ready
        if: matrix.needs_jwkserve == true
        run: |
          timeout 30 bash -c 'until curl -sf http://localhost:3000/.well-known/openid-configuration; do sleep 1; done'

      - name: Run all tests
        run: |
          if [ -z "${{ matrix.features }}" ]; then
            cargo test --lib --tests --bins --examples
          else
            cargo test --lib --tests --bins --examples --features "${{ matrix.features }}"
          fi

  # Release-mode tests - critical Ring paths
  all-tests-release:
    name: All Tests (Release)
    runs-on: ubuntu-latest
    services:
      jwkserve:
        image: sbstjn/jwkserve:latest
        ports:
          - 3000:3000
    strategy:
      fail-fast: false
      matrix:
        include:
          - features: "all-algorithms"
            name: All (Ring)
            needs_jwkserve: false
          - features: "all-algorithms,remote"
            name: All + Remote
            needs_jwkserve: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-all-release-${{ matrix.name }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-all-release-${{ matrix.name }}-
            ${{ runner.os }}-cargo-

      - name: Wait for jwkserve to be ready
        if: matrix.needs_jwkserve == true
        run: |
          timeout 30 bash -c 'until curl -sf http://localhost:3000/.well-known/openid-configuration; do sleep 1; done'

      - name: Run all tests (release)
        run: |
          if [ -z "${{ matrix.features }}" ]; then
            cargo test --release --lib --tests --bins --examples
          else
            cargo test --release --lib --tests --bins --examples --features "${{ matrix.features }}"
          fi

  # Benchmarks - run in parallel on pull requests
  benchmarks:
    if: github.event_name == 'pull_request'
    name: Benchmarks (${{ matrix.group }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - group: RSA
            features: "rsa"
            benches: "rsa_end_to_end rsa_signature_verification"
          - group: HMAC
            features: ""
            benches: "hmac_algorithms"
          - group: ECDSA
            features: "ecdsa"
            benches: "ecdsa_algorithms"
          - group: Claims
            features: ""
            benches: "claims_validation"
          - group: Selection
            features: ""
            benches: "algorithm_selection"
          - group: Token
            features: ""
            benches: "token_parsing"
          - group: JWKS
            features: "remote"
            benches: "jwks_caching"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-bench-${{ matrix.group }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-bench-${{ matrix.group }}-
            ${{ runner.os }}-cargo-

      - name: Run benchmarks
        run: |
          for bench in ${{ matrix.benches }}; do
            echo "Running benchmark: $bench"
            cargo bench --bench "$bench" --features "${{ matrix.features }}"
          done

  # Bundle size tracking - run in parallel
  bundle-size:
    name: Bundle Size (${{ matrix.label }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - features: ""
            name: "default"
            label: "Default (HMAC)"
          - features: "rsa"
            name: "rsa"
            label: "RSA"
          - features: "ecdsa"
            name: "ecdsa"
            label: "ECDSA"
          - features: "all-algorithms"
            name: "all-algorithms"
            label: "All Algorithms (Ring)"
          - features: "all-algorithms,remote"
            name: "all-algorithms-remote"
            label: "All Algorithms + Remote"
          - features: "rsa,aws-lc-rs"
            name: "rsa-aws-lc"
            label: "RSA (aws-lc-rs)"
          - features: "all-algorithms,aws-lc-rs"
            name: "all-algorithms-aws-lc"
            label: "All Algorithms (aws-lc-rs)"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-size-${{ matrix.name }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-size-${{ matrix.name }}-
            ${{ runner.os }}-cargo-

      - name: Build library in release mode
        run: |
          if [ -z "${{ matrix.features }}" ]; then
            cargo build --release --lib
          else
            cargo build --release --lib --features "${{ matrix.features }}"
          fi

      - name: Measure bundle size
        id: size
        run: ./scripts/measure-bundle-size.sh "${{ matrix.name }}" "${{ matrix.label }}" "${{ matrix.features }}"

      - name: Upload size JSON
        uses: actions/upload-artifact@v4
        if: ${{ false }}
        with:
          name: bundle-size-json-${{ matrix.name }}
          path: bundle-sizes/${{ matrix.name }}.json
          retention-days: 7

  cargo-deny:
    name: Cargo Deny
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-deny-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-deny-
            ${{ runner.os }}-cargo-

      - name: Install cargo-deny
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-deny

      - name: Run cargo-deny
        run: cargo deny check

  # Release - run after all tests and checks
  release:
    runs-on: ubuntu-latest
    needs: [lint, docs, all-tests-tag, all-tests-release, msrv, cargo-deny]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.RELEASE_TOKEN }}

      - name: Semantic Release
        uses: cycjimmy/semantic-release-action@v5
        with:
          extra_plugins: |
            @semantic-release/git
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
